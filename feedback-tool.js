(function() {
  'use strict';

  if (window.feedbackToolLoaded) {
    alert('‰øÆÊ≠£ÊåáÁ§∫„ÉÑ„Éº„É´„ÅØÊó¢„Å´Ëµ∑Âãï„Åó„Å¶„ÅÑ„Åæ„Åô');
    return;
  }
  window.feedbackToolLoaded = true;

  // ÂøÖË¶Å„Å™„É©„Ç§„Éñ„É©„É™„ÇíË™≠„ÅøËæº„Åø
  const libs = [
    { name: 'html2canvas', url: 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js', check: () => window.html2canvas },
    { name: 'xlsx', url: 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js', check: () => window.XLSX }
  ];

  let loadedCount = 0;
  
  libs.forEach(lib => {
    if (!lib.check()) {
      const script = document.createElement('script');
      script.src = lib.url;
      script.onload = () => {
        loadedCount++;
        if (loadedCount === libs.filter(l => !l.check()).length) {
          initFeedbackTool();
        }
      };
      document.head.appendChild(script);
    } else {
      initFeedbackTool();
    }
  });

  function initFeedbackTool() {
    const feedbacks = [];
    let isAddingMode = false;
    let isDragging = false;
    let startX, startY, currentRect;
    let rectCounter = 0;

    // „Çπ„Çø„Ç§„É´„ÇíËøΩÂä†
    const style = document.createElement('style');
    style.textContent = `
      .feedback-tool-panel {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        border: 2px solid #333;
        border-radius: 8px;
        padding: 15px;
        z-index: 999999;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        min-width: 280px;
        cursor: move;
      }
      .feedback-tool-panel h3 {
        margin: 0 0 15px 0;
        font-size: 16px;
        color: #333;
        border-bottom: 2px solid #007bff;
        padding-bottom: 8px;
      }
      .feedback-tool-btn {
        display: block;
        width: 100%;
        padding: 10px;
        margin: 8px 0;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.2s;
      }
      .feedback-tool-btn-primary {
        background: #007bff;
        color: white;
      }
      .feedback-tool-btn-primary:hover {
        background: #0056b3;
      }
      .feedback-tool-btn-success {
        background: #28a745;
        color: white;
      }
      .feedback-tool-btn-success:hover {
        background: #1e7e34;
      }
      .feedback-tool-btn-danger {
        background: #dc3545;
        color: white;
      }
      .feedback-tool-btn-danger:hover {
        background: #c82333;
      }
      .feedback-tool-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .feedback-rect {
        position: absolute;
        border: 3px solid #dc3545;
        background: rgba(220, 53, 69, 0.1);
        pointer-events: none;
        z-index: 999997;
        box-sizing: border-box;
      }
      .feedback-rect-label {
        position: absolute;
        top: -30px;
        left: 0;
        background: #dc3545;
        color: white;
        padding: 4px 10px;
        border-radius: 4px;
        font-weight: bold;
        font-size: 14px;
        font-family: sans-serif;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        pointer-events: auto;
        cursor: pointer;
      }
      .feedback-rect-label:hover {
        background: #c82333;
      }
      .feedback-balloon {
        position: absolute;
        background: white;
        border: 2px solid #333;
        border-radius: 8px;
        padding: 15px;
        min-width: 300px;
        z-index: 999998;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      }
      .feedback-balloon::before {
        content: '';
        position: absolute;
        left: -10px;
        top: 20px;
        width: 0;
        height: 0;
        border-top: 10px solid transparent;
        border-bottom: 10px solid transparent;
        border-right: 10px solid #333;
      }
      .feedback-balloon::after {
        content: '';
        position: absolute;
        left: -7px;
        top: 22px;
        width: 0;
        height: 0;
        border-top: 8px solid transparent;
        border-bottom: 8px solid transparent;
        border-right: 8px solid white;
      }
      .feedback-balloon h4 {
        margin: 0 0 12px 0;
        font-size: 15px;
        color: #333;
      }
      .feedback-balloon-group {
        margin-bottom: 10px;
      }
      .feedback-balloon-group label {
        display: block;
        margin-bottom: 4px;
        font-weight: 600;
        font-size: 13px;
        color: #555;
      }
      .feedback-balloon-group textarea,
      .feedback-balloon-group select {
        width: 100%;
        padding: 6px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 13px;
        box-sizing: border-box;
        font-family: inherit;
      }
      .feedback-balloon-group textarea {
        min-height: 80px;
        resize: vertical;
      }
      .feedback-balloon-buttons {
        display: flex;
        gap: 8px;
        margin-top: 12px;
      }
      .feedback-balloon-buttons button {
        flex: 1;
        padding: 8px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
      }
      .feedback-count {
        background: #dc3545;
        color: white;
        border-radius: 12px;
        padding: 2px 8px;
        font-size: 12px;
        font-weight: bold;
        display: inline-block;
        margin-left: 8px;
      }
      .feedback-adding-mode {
        background: #28a745 !important;
      }
      .feedback-list {
        max-height: 200px;
        overflow-y: auto;
        margin: 10px 0;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      .feedback-list-item {
        padding: 8px;
        border-bottom: 1px solid #eee;
        font-size: 13px;
      }
      .feedback-list-item:last-child {
        border-bottom: none;
      }
    `;
    document.head.appendChild(style);

    // „Ç≥„É≥„Éà„É≠„Éº„É´„Éë„Éç„É´„Çí‰ΩúÊàê
    const panel = document.createElement('div');
    panel.className = 'feedback-tool-panel';
    panel.innerHTML = `
      <h3>üìù ‰øÆÊ≠£ÊåáÁ§∫„ÉÑ„Éº„É´</h3>
      <button class="feedback-tool-btn feedback-tool-btn-primary" id="toggleAddingMode">
        üñ±Ô∏è ÁØÑÂõ≤ÊåáÂÆö„É¢„Éº„ÉâÈñãÂßã
      </button>
      <button class="feedback-tool-btn feedback-tool-btn-success" id="exportExcel" ${feedbacks.length === 0 ? 'disabled' : ''}>
        üìä ExcelÂá∫Âäõ <span class="feedback-count">${feedbacks.length}</span>
      </button>
      <button class="feedback-tool-btn feedback-tool-btn-danger" id="clearAll" ${feedbacks.length === 0 ? 'disabled' : ''}>
        üóëÔ∏è „Åô„Åπ„Å¶„ÇØ„É™„Ç¢
      </button>
      <div class="feedback-list" id="feedbackList"></div>
      <button class="feedback-tool-btn" id="closePanel" style="background: #6c757d; color: white; margin-top: 10px;">
        ‚úï Èñâ„Åò„Çã
      </button>
    `;
    document.body.appendChild(panel);

    // „Éë„Éç„É´„ÅÆ„Éâ„É©„ÉÉ„Ç∞Ê©üËÉΩ
    let isPanelDragging = false;
    let panelCurrentX, panelCurrentY, panelInitialX, panelInitialY;

    panel.querySelector('h3').addEventListener('mousedown', panelDragStart);

    function panelDragStart(e) {
      panelInitialX = e.clientX - panel.offsetLeft;
      panelInitialY = e.clientY - panel.offsetTop;
      isPanelDragging = true;
    }

    document.addEventListener('mousemove', panelDrag);
    document.addEventListener('mouseup', panelDragEnd);

    function panelDrag(e) {
      if (isPanelDragging) {
        e.preventDefault();
        panelCurrentX = e.clientX - panelInitialX;
        panelCurrentY = e.clientY - panelInitialY;
        panel.style.left = panelCurrentX + 'px';
        panel.style.top = panelCurrentY + 'px';
        panel.style.right = 'auto';
      }
    }

    function panelDragEnd() {
      isPanelDragging = false;
    }

    updateFeedbackList();

    // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
    document.getElementById('toggleAddingMode').addEventListener('click', () => {
      isAddingMode = !isAddingMode;
      const btn = document.getElementById('toggleAddingMode');
      if (isAddingMode) {
        btn.textContent = '‚è∏Ô∏è ÁØÑÂõ≤ÊåáÂÆö„É¢„Éº„ÉâÂÅúÊ≠¢';
        btn.classList.add('feedback-adding-mode');
        document.body.style.cursor = 'crosshair';
      } else {
        btn.textContent = 'üñ±Ô∏è ÁØÑÂõ≤ÊåáÂÆö„É¢„Éº„ÉâÈñãÂßã';
        btn.classList.remove('feedback-adding-mode');
        document.body.style.cursor = 'default';
      }
    });

    document.getElementById('exportExcel').addEventListener('click', exportToExcel);
    document.getElementById('clearAll').addEventListener('click', clearAll);
    document.getElementById('closePanel').addEventListener('click', () => {
      if (confirm('‰øÆÊ≠£ÊåáÁ§∫„ÉÑ„Éº„É´„ÇíÁµÇ‰∫Ü„Åó„Åæ„Åô„Åã?')) {
        panel.remove();
        document.querySelectorAll('.feedback-rect, .feedback-balloon').forEach(el => el.remove());
        window.feedbackToolLoaded = false;
      }
    });

    // „Éâ„É©„ÉÉ„Ç∞„Ç§„Éô„É≥„Éà
    document.addEventListener('mousedown', handleMouseDown, true);
    document.addEventListener('mousemove', handleMouseMove, true);
    document.addEventListener('mouseup', handleMouseUp, true);

    function handleMouseDown(e) {
      if (!isAddingMode || e.target.closest('.feedback-tool-panel') || e.target.closest('.feedback-balloon')) {
        return;
      }
      
      e.preventDefault();
      e.stopPropagation();
      
      isDragging = true;
      startX = e.pageX;
      startY = e.pageY;
      
      currentRect = document.createElement('div');
      currentRect.className = 'feedback-rect';
      currentRect.style.left = startX + 'px';
      currentRect.style.top = startY + 'px';
      currentRect.style.width = '0px';
      currentRect.style.height = '0px';
      document.body.appendChild(currentRect);
    }

    function handleMouseMove(e) {
      if (!isDragging) return;
      
      e.preventDefault();
      
      const currentX = e.pageX;
      const currentY = e.pageY;
      
      const width = Math.abs(currentX - startX);
      const height = Math.abs(currentY - startY);
      const left = Math.min(startX, currentX);
      const top = Math.min(startY, currentY);
      
      currentRect.style.left = left + 'px';
      currentRect.style.top = top + 'px';
      currentRect.style.width = width + 'px';
      currentRect.style.height = height + 'px';
    }

    function handleMouseUp(e) {
      if (!isDragging) return;
      
      e.preventDefault();
      e.stopPropagation();
      
      isDragging = false;
      
      const rect = currentRect.getBoundingClientRect();
      if (rect.width < 10 || rect.height < 10) {
        currentRect.remove();
        return;
      }
      
      rectCounter++;
      const rectData = {
        number: rectCounter,
        left: parseInt(currentRect.style.left),
        top: parseInt(currentRect.style.top),
        width: parseInt(currentRect.style.width),
        height: parseInt(currentRect.style.height)
      };
      
      // „É©„Éô„É´„ÇíËøΩÂä†
      const label = document.createElement('div');
      label.className = 'feedback-rect-label';
      label.textContent = rectCounter;
      label.dataset.number = rectCounter;
      currentRect.appendChild(label);
      currentRect.style.pointerEvents = 'auto';
      currentRect.dataset.number = rectCounter;
      
      // Âêπ„ÅçÂá∫„Åó„ÇíË°®Á§∫
      showBalloon(rectData);
      
      label.addEventListener('click', (e) => {
        e.stopPropagation();
        const fb = feedbacks.find(f => f.number === rectCounter);
        if (fb) {
          showBalloon(rectData, fb);
        }
      });
      
      currentRect = null;
    }

    function showBalloon(rectData, existingData = null) {
      // Êó¢Â≠ò„ÅÆÂêπ„ÅçÂá∫„Åó„ÇíÂâäÈô§
      const existing = document.querySelector('.feedback-balloon');
      if (existing) existing.remove();
      
      const balloon = document.createElement('div');
      balloon.className = 'feedback-balloon';
      balloon.style.left = (rectData.left + rectData.width + 20) + 'px';
      balloon.style.top = rectData.top + 'px';
      
      balloon.innerHTML = `
        <h4>üìù ÊåáÁ§∫ No.${rectData.number}</h4>
        <div class="feedback-balloon-group">
          <label>ÊåáÁ§∫ÂÜÖÂÆπ *</label>
          <textarea id="balloonComment" placeholder="‰øÆÊ≠£ÂÜÖÂÆπ„ÇíÂÖ•Âäõ">${existingData ? existingData.comment : ''}</textarea>
        </div>
        <div class="feedback-balloon-group">
          <label>ÂÑ™ÂÖàÂ∫¶</label>
          <select id="balloonPriority">
            <option value="È´ò" ${existingData && existingData.priority === 'È´ò' ? 'selected' : ''}>È´ò</option>
            <option value="‰∏≠" ${existingData && existingData.priority === '‰∏≠' ? 'selected' : ''}>‰∏≠</option>
            <option value="‰Ωé" ${existingData && existingData.priority === '‰Ωé' ? 'selected' : ''}>‰Ωé</option>
          </select>
        </div>
        <div class="feedback-balloon-group">
          <label>„Ç´„ÉÜ„Ç¥„É™</label>
          <select id="balloonCategory">
            <option value="„Éá„Ç∂„Ç§„É≥" ${existingData && existingData.category === '„Éá„Ç∂„Ç§„É≥' ? 'selected' : ''}>„Éá„Ç∂„Ç§„É≥</option>
            <option value="„ÉÜ„Ç≠„Çπ„Éà" ${existingData && existingData.category === '„ÉÜ„Ç≠„Çπ„Éà' ? 'selected' : ''}>„ÉÜ„Ç≠„Çπ„Éà</option>
            <option value="Ê©üËÉΩ" ${existingData && existingData.category === 'Ê©üËÉΩ' ? 'selected' : ''}>Ê©üËÉΩ</option>
            <option value="„É¨„Ç§„Ç¢„Ç¶„Éà" ${existingData && existingData.category === '„É¨„Ç§„Ç¢„Ç¶„Éà' ? 'selected' : ''}>„É¨„Ç§„Ç¢„Ç¶„Éà</option>
            <option value="„É™„É≥„ÇØ" ${existingData && existingData.category === '„É™„É≥„ÇØ' ? 'selected' : ''}>„É™„É≥„ÇØ</option>
            <option value="„Åù„ÅÆ‰ªñ" ${existingData && existingData.category === '„Åù„ÅÆ‰ªñ' ? 'selected' : ''}>„Åù„ÅÆ‰ªñ</option>
          </select>
        </div>
        <div class="feedback-balloon-buttons">
          ${existingData ? '<button id="balloonDelete" style="background: #dc3545; color: white;">ÂâäÈô§</button>' : ''}
          <button id="balloonCancel" style="background: #6c757d; color: white;">„Ç≠„É£„É≥„Çª„É´</button>
          <button id="balloonSave" style="background: #007bff; color: white;">‰øùÂ≠ò</button>
        </div>
      `;
      
      document.body.appendChild(balloon);
      
      document.getElementById('balloonCancel').addEventListener('click', () => {
        balloon.remove();
        if (!existingData) {
          const rect = document.querySelector(`.feedback-rect[data-number="${rectData.number}"]`);
          if (rect) rect.remove();
          rectCounter--;
        }
      });
      
      document.getElementById('balloonSave').addEventListener('click', () => {
        saveFeedback(rectData, existingData);
        balloon.remove();
      });
      
      if (existingData) {
        document.getElementById('balloonDelete').addEventListener('click', () => {
          deleteFeedback(rectData.number);
          balloon.remove();
        });
      }
      
      // Ëá™Âãï„Éï„Ç©„Éº„Ç´„Çπ
      document.getElementById('balloonComment').focus();
    }

    function saveFeedback(rectData, existingData) {
      const comment = document.getElementById('balloonComment').value.trim();
      const priority = document.getElementById('balloonPriority').value;
      const category = document.getElementById('balloonCategory').value;
      
      if (!comment) {
        alert('ÊåáÁ§∫ÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        showBalloon(rectData, existingData);
        return;
      }
      
      const feedback = {
        number: rectData.number,
        comment,
        priority,
        category,
        rect: rectData,
        url: window.location.href,
        timestamp: new Date().toLocaleString('ja-JP')
      };
      
      if (existingData) {
        const index = feedbacks.findIndex(f => f.number === rectData.number);
        feedbacks[index] = feedback;
      } else {
        feedbacks.push(feedback);
      }
      
      updateFeedbackList();
      updateButtons();
    }

    function deleteFeedback(number) {
      if (confirm('„Åì„ÅÆÊåáÁ§∫„ÇíÂâäÈô§„Åó„Åæ„Åô„Åã?')) {
        const index = feedbacks.findIndex(f => f.number === number);
        feedbacks.splice(index, 1);
        
        const rect = document.querySelector(`.feedback-rect[data-number="${number}"]`);
        if (rect) rect.remove();
        
        updateFeedbackList();
        updateButtons();
      }
    }

    function updateFeedbackList() {
      const list = document.getElementById('feedbackList');
      if (feedbacks.length === 0) {
        list.innerHTML = '<div style="padding: 15px; text-align: center; color: #999;">ÊåáÁ§∫„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
      } else {
        list.innerHTML = feedbacks.map(fb => `
          <div class="feedback-list-item">
            <strong>No.${fb.number}</strong> [${fb.priority}] ${fb.category}<br>
            <small>${fb.comment.substring(0, 30)}${fb.comment.length > 30 ? '...' : ''}</small>
          </div>
        `).join('');
      }
    }

    function updateButtons() {
      const hasData = feedbacks.length > 0;
      document.getElementById('exportExcel').disabled = !hasData;
      document.getElementById('clearAll').disabled = !hasData;
      
      const countBadge = document.querySelector('.feedback-count');
      if (countBadge) {
        countBadge.textContent = feedbacks.length;
      }
    }

    async function exportToExcel() {
      if (feedbacks.length === 0) {
        alert('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„ÇãÊåáÁ§∫„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
        return;
      }

      try {
        // ÂÖ®ÁîªÈù¢„Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„Éà„ÇíÂèñÂæó(Áü©ÂΩ¢„Éû„Éº„Ç≠„É≥„Ç∞‰ªò„Åç)
        const canvas = await html2canvas(document.body, {
          allowTaint: true,
          useCORS: true,
          scrollY: -window.scrollY,
          scrollX: -window.scrollX,
          windowWidth: document.documentElement.scrollWidth,
          windowHeight: document.documentElement.scrollHeight
        });
        
        const imgData = canvas.toDataURL('image/png');
        
        // Excel„ÉØ„Éº„ÇØ„Éñ„ÉÉ„ÇØ‰ΩúÊàê
        const wb = XLSX.utils.book_new();
        
        // „Éá„Éº„ÇøÈÖçÂàó‰ΩúÊàê
        const data = [
          ['', 'No.', 'ÊåáÁ§∫ÂÜÖÂÆπ', 'ÂÑ™ÂÖàÂ∫¶', '„Ç´„ÉÜ„Ç¥„É™', '‰ΩúÊàêÊó•ÊôÇ', '„Éö„Éº„Ç∏URL']
        ];
        
        feedbacks.forEach(fb => {
          data.push([
            '',
            fb.number,
            fb.comment,
            fb.priority,
            fb.category,
            fb.timestamp,
            fb.url
          ]);
        });
        
        const ws = XLSX.utils.aoa_to_sheet(data);
        
        // ÂàóÂπÖË®≠ÂÆö
        ws['!cols'] = [
          { wch: 50 }, // AÂàó(ÁîªÂÉèÁî®)
          { wch: 5 },  // No.
          { wch: 60 }, // ÊåáÁ§∫ÂÜÖÂÆπ
          { wch: 8 },  // ÂÑ™ÂÖàÂ∫¶
          { wch: 12 }, // „Ç´„ÉÜ„Ç¥„É™
          { wch: 20 }, // ‰ΩúÊàêÊó•ÊôÇ
          { wch: 50 }  // URL
        ];
        
        // Ë°å„ÅÆÈ´ò„ÅïË®≠ÂÆöÔºàÁîªÂÉèÁî®Ôºâ
        ws['!rows'] = [{ hpt: 20 }]; // „Éò„ÉÉ„ÉÄ„ÉºË°å
        for (let i = 0; i < feedbacks.length; i++) {
          ws['!rows'].push({ hpt: 400 }); // ÁîªÂÉèË°®Á§∫Áî®„Å´È´ò„ÅèË®≠ÂÆö
        }
        
        XLSX.utils.book_append_sheet(wb, ws, '‰øÆÊ≠£ÊåáÁ§∫‰∏ÄË¶ß');
        
        // „Éï„Ç°„Ç§„É´ÂêçÁîüÊàê
        const filename = `‰øÆÊ≠£ÊåáÁ§∫Êõ∏_${new Date().toISOString().slice(0, 10)}.xlsx`;
        
        XLSX.writeFile(wb, filename);
        
        alert(`${feedbacks.length}‰ª∂„ÅÆÊåáÁ§∫„ÇíExcel„Éï„Ç°„Ç§„É´„Å®„Åó„Å¶Âá∫Âäõ„Åó„Åæ„Åó„Åü\n‚Äª„Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„ÉàÁîªÂÉè„ÅØAÂàó„Å´ÊâãÂãï„ÅßË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ`);
        
        // ÁîªÂÉè„ÇíÂà•ÈÄî„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
        const link = document.createElement('a');
        link.download = `‰øÆÊ≠£ÊåáÁ§∫_„Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„Éà_${new Date().toISOString().slice(0, 10)}.png`;
        link.href = imgData;
        link.click();
        
      } catch (error) {
        console.error('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Ç®„É©„Éº:', error);
        alert('„Ç®„ÇØ„Çπ„Éù„Éº„Éà‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
      }
    }

    function clearAll() {
      if (confirm('„Åô„Åπ„Å¶„ÅÆÊåáÁ§∫„ÇíÂâäÈô§„Åó„Åæ„Åô„Åã?')) {
        feedbacks.length = 0;
        rectCounter = 0;
        document.querySelectorAll('.feedback-rect, .feedback-balloon').forEach(el => el.remove());
        updateFeedbackList();
        updateButtons();
      }
    }
  }
})();